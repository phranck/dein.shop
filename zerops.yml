zerops:
  # BACKEND SERVICE (Hono + Node.js)
  - setup: backend
    build:
      base: nodejs@22
      buildCommands:
        - npm install
        - npm run build -w @dein-shop/shared
        - npm run build -w @dein-shop/backend
      deployFiles:
        - apps/backend/dist
        - apps/backend/package.json
        - node_modules
        - packages/shared
        - package.json
      cache: node_modules
    run:
      base: nodejs@22
      ports:
        - port: 3000
          httpSupport: true
      envVariables:
        HOST: 0.0.0.0
        PORT: "3000"
        NODE_ENV: production
        DATABASE_PATH: /mnt/sharedstorage/deinshop.db
        # Secrets (set in Zerops dashboard):
        # RESEND_API_KEY
        # SESSION_SECRET
        # EMAIL_FROM
      initCommands:
        - while ! touch /mnt/sharedstorage/.probe 2>/dev/null; do sleep 1; done && rm -f /mnt/sharedstorage/.probe
        - node apps/backend/dist/db/migrate.js
        - node apps/backend/dist/scripts/seed.js
      start: node apps/backend/dist/index.js

  # FRONTEND SERVICE (React + Vite → Static)
  - setup: frontend
    build:
      base: nodejs@22
      buildCommands:
        - npm install
        - npm run build -w @dein-shop/shared
        - npm run build -w @dein-shop/frontend
      deployFiles:
        - apps/frontend/dist
      cache: node_modules
    run:
      base: nginx@1.22
      ports:
        - port: 80
          httpSupport: true
      envVariables:
        VITE_API_URL: https://api.dein.shop/api

  # DASHBOARD SERVICE (React + Vite → Static)
  - setup: dashboard
    build:
      base: nodejs@22
      buildCommands:
        - npm install
        - npm run build -w @dein-shop/shared
        - npm run build -w @dein-shop/dashboard
      deployFiles:
        - apps/dashboard/dist
      cache: node_modules
    run:
      base: nginx@1.22
      ports:
        - port: 80
          httpSupport: true
